<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pose Capture - Motion Detection Game</title>
    
    <!-- Polyfills for ancient browsers -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/2.6.11/core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/raf/3.4.1/raf.min.js"></script>
    
    <!-- AI libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <!-- CSS Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@1,800;1,900&display=swap');
        :root{--rb-blue:#0d214a;--rb-red:#c51b22;--rb-yellow:#fecb0a;--rb-yellow-dark:#f7941d;--rb-silver:#d1d3d4;--rb-white:#ffffff}
        body{font-family:'Exo 2',sans-serif;font-style:italic;background:var(--rb-red);color:var(--rb-blue);display:flex;justify-content:center;min-height:100vh;margin:0;padding:20px;box-sizing:border-box}
        .can-frame{background:var(--rb-red);padding:15px;border-radius:25px;box-shadow:0 15px 40px rgba(0,0,0,0.4),inset 0 0 10px rgba(0,0,0,0.5);width:100%;max-width:550px}
        .main-container{text-align:center;background:var(--rb-blue);padding:20px;border-radius:15px;border:2px solid rgba(255,255,255,0.5);position:relative}
        .header{position:relative;padding:10px;margin-bottom:20px}
        .header-bar{width:100%;height:4px;background:linear-gradient(to right,var(--rb-white),var(--rb-silver));border-radius:2px}
        .header-line{width:100%;height:2px;background:var(--rb-red);margin-top:2px}
        .energy-tag{position:absolute;top:0;right:10px;background:linear-gradient(to right,var(--rb-yellow),var(--rb-yellow-dark));color:var(--rb-blue);padding:2px 8px;font-size:.7em;font-weight:900;border-radius:5px}
        h1{color:var(--rb-white);font-size:2.8em;font-weight:900;margin:0;text-shadow:2px 2px 4px rgba(0,0,0,0.3)}
        .game-window{position:relative;width:100%;height:0;padding-top:177.78%;border:4px solid var(--rb-red);overflow:hidden;background-color:#000;border-radius:5px}
        .game-window > video, .game-window > img, .game-window > canvas, .game-window > .ui-overlay {position: absolute; top: 0; left: 0; width: 100%; height: 100%;}
        video{z-index:1;transform:scaleX(-1);filter:brightness(160%) contrast(110%);object-fit:cover}
        #pose-image-guide{z-index:2;object-fit:contain;opacity:0.65;pointer-events:none}
        canvas{z-index:3;pointer-events:none}
        .ui-overlay{z-index:10;display:flex;flex-direction:column;justify-content:center;align-items:center;background-color:rgba(0,0,0,0.7)}
        .ui-overlay>div{text-align:center;color:white;text-shadow:0 0 8px rgba(0,0,0,0.8)}
        .score-board,button{background:var(--rb-red);color:var(--rb-white);border:none;padding:15px 40px;font-size:1.5em;font-family:'Exo 2',sans-serif;font-weight:900;cursor:pointer;transition:all .2s ease-in-out;margin-top:25px;display:inline-block;transform:skewX(-10deg)}
        button:disabled{background-color:#555;color:#999;cursor:not-allowed}
        button:not(:disabled):hover{background:var(--rb-yellow);color:var(--rb-blue)}
        .score-board h2{font-size:1em;margin:0;transform:skewX(10deg)}
        .score-board.success{background-color:var(--rb-yellow)}
        .score-board.success h2{color:var(--rb-blue)}
        .countdown-text{font-size:10em;font-weight:900;color:#fff;text-shadow:0 0 20px var(--rb-red);animation:zoom-in-out 1s infinite}
        @keyframes zoom-in-out{50%{transform:scale(1.1)}}
        #transition-screen>p,#end-screen h2{font-size:2em;margin-top:-20px}
        #end-screen .trophy{font-size:5em;filter:drop-shadow(0 0 15px var(--rb-yellow))}
        #progress-container{position:absolute;bottom:10px;left:5%;width:90%;height:15px;background-color:rgba(0,0,0,0.5);border:2px solid rgba(255,255,255,0.7);border-radius:10px;overflow:hidden;z-index:5}
        #progress-bar{width:0%;height:100%;background-color:var(--rb-yellow);border-radius:8px;transition:width .1s linear}
        .hidden{display:none !important}
        #start-screen h2 { font-size: 2em; margin-bottom: 20px; }
        #start-screen .error-message { color: var(--rb-white); margin-top: -10px; margin-bottom: 20px; font-size: 1.5em; font-style: normal; }
        #start-screen .error-recommendation { color: var(--rb-silver); margin-top: 20px; font-size: 1em; font-style: normal; }
        @media (max-width: 768px){.can-frame{padding:10px;width:auto}.main-container{padding:15px}h1{font-size:2em}.header{margin-bottom:15px}.energy-tag{font-size:.6em}.score-board,button{font-size:1.2em;padding:12px 25px;margin-top:15px}.countdown-text{font-size:8em}#transition-screen>p,#end-screen h2{font-size:1.5em}#end-screen .trophy{font-size:4em}#start-screen h2{font-size:1.5em}#start-screen .error-message{font-size:1.2em}#start-screen .error-recommendation{font-size:.9em}}
        @media (orientation: landscape) and (max-height: 500px){.can-frame{max-width:90vh;margin:auto}.game-window{padding-top:100%}h1{font-size:1.8em}.header{margin-bottom:10px}.score-board,button{font-size:1em;padding:8px 20px;margin-top:10px}}
        @media (min-height: 800px) { body { align-items: center; } }
    </style>
</head>
<body>
    <div class="can-frame">
        <div class="main-container">
            <div class="header">
                <span class="energy-tag">HIGH ENERGY</span>
                <div class="header-bar"></div>
                <div class="header-line"></div>
            </div>
            <h1>Pose Capture</h1>
            <div class="game-window">
                <video id="webcam" autoplay playsinline></video>
                <img id="pose-image-guide" class="hidden" />
                <canvas id="canvas"></canvas>
                <div id="progress-container" class="hidden">
                    <div id="progress-bar"></div>
                </div>
                <div id="ui-overlay" class="ui-overlay">
                    <div id="start-screen">
                        <h2 id="start-title">Are you ready?</h2>
                        <button id="start-button" disabled>Loading...</button>
                    </div>
                    <div id="countdown-screen" class="hidden"><span class="countdown-text">3</span></div>
                    <div id="transition-screen" class="hidden">
                        <span id="transition-timer" class="countdown-text">5</span>
                        <p>Get ready for the next pose!</p>
                    </div>
                    <div id="end-screen" class="hidden">
                        <div class="trophy">üèÜ</div>
                        <h2>Challenge Complete!</h2>
                        <button id="restart-button">Play Again</button>
                    </div>
                </div>
            </div>
            <div id="instruction-board" class="score-board">
                <h2 id="instruction-text"></h2>
            </div>
        </div>
    </div>

    <script>
        var videoElement=document.getElementById("webcam"),poseImageGuide=document.getElementById("pose-image-guide"),instructionBoard=document.getElementById("instruction-board"),instructionText=document.getElementById("instruction-text"),startButton=document.getElementById("start-button"),startTitle=document.getElementById("start-title"),startScreen=document.getElementById("start-screen"),countdownScreen=document.getElementById("countdown-screen"),transitionScreen=document.getElementById("transition-screen"),transitionTimer=document.getElementById("transition-timer"),endScreen=document.getElementById("end-screen"),restartButton=document.getElementById("restart-button"),progressContainer=document.getElementById("progress-container"),progressBar=document.getElementById("progress-bar"),detector,gameLoopId,gameState="waiting",gameStage=0,STAGE_NAMES=["Squat","High Lunge","Side Bend","Hands Behind Head","Forward Punch"],POSE_IMAGE_URLS=["img/squat.png","img/high_lunge.png","img/side_bend.png","img/hands_behind_head.png","img/forward_punch.png"],poseHoldCounter=0,POSE_HOLD_FRAMES=30;function setupCamera(){return new Promise(function(e,t){navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({video:{width:640,height:480},audio:!1}).then(function(t){videoElement.srcObject=t,videoElement.onloadedmetadata=function(){e(!0)}}).catch(function(e){t(new Error("Camera permission denied."))}):t(new Error("Browser does not support camera."))})}
        
        // --- UPDATED: This function now loads the model from a local path ---
        function loadPoseDetector(){
            return new Promise(function(e,t){
                if(!window.poseDetection) return t(new Error("AI Library failed to load."));
                
                // Define the configuration for the local model
                var detectorConfig = {
                    modelType: poseDetection.movenet.modelType.SINGLEPOSE_THUNDER,
                    modelUrl: './model.json' // The key change is here!
                };

                poseDetection.createDetector(poseDetection.SupportedModels.MoveNet, detectorConfig)
                    .then(function(loadedDetector){
                        detector = loadedDetector;
                        e(true);
                    })
                    .catch(function(error){
                        console.error("Local AI Model failed to load:", error);
                        t(new Error("AI Model incompatible or not found."));
                    });
            });
        }
        
        function startGame(){gameState="countdown",startScreen.classList.add("hidden"),countdownScreen.classList.remove("hidden");var e=3;countdownScreen.querySelector(".countdown-text").textContent=e;var t=setInterval(function(){--e>0?countdownScreen.querySelector(".countdown-text").textContent=e:(clearInterval(t),countdownScreen.classList.add("hidden"),progressContainer.classList.remove("hidden"),gameState="playing",gameLoopId||gameLoop())},1e3)}function triggerTransition(){gameState="transitioning",instructionBoard.classList.add("success"),instructionText.textContent="Pose Recognized!",progressContainer.classList.add("hidden");var e=5;transitionTimer.textContent=e,transitionScreen.classList.remove("hidden");var t=setInterval(function(){--e>0?transitionTimer.textContent=e:(clearInterval(t),transitionScreen.classList.add("hidden"),gameStage++,instructionText.textContent="MATCH THE POSE",instructionBoard.classList.remove("success"),poseHoldCounter=0,progressContainer.classList.remove("hidden"),gameState="playing")},1e3)}function finishGame(){gameState="finished",gameLoopId&&cancelAnimationFrame(gameLoopId),gameLoopId=null,progressContainer.classList.add("hidden"),endScreen.classList.remove("hidden")}function resetGame(){gameStage=0,poseHoldCounter=0,instructionText.textContent="MATCH THE POSE",instructionBoard.classList.remove("success"),endScreen.classList.add("hidden"),startScreen.classList.remove("hidden"),progressBar.style.width="0%",progressContainer.classList.add("hidden"),gameState="waiting",setTimeout(function(){gameLoopId||gameLoop()},0)}function gameLoop(){"playing"===gameState&&detector&&detector.estimatePoses(videoElement,{flipHorizontal:!1}).then(function(e){e&&e.length>0&&checkGameLogic(e[0].keypoints)}).catch(function(e){console.error("Pose estimation error:",e)}),drawActionFrame(),"finished"!==gameState&&(gameLoopId=requestAnimationFrame(gameLoop))}function drawActionFrame(){"playing"!==gameState?poseImageGuide.classList.add("hidden"):(poseImageGuide.src.indexOf(POSE_IMAGE_URLS[gameStage])===-1&&(poseImageGuide.src=POSE_IMAGE_URLS[gameStage]),poseImageGuide.classList.remove("hidden"))}function calculateAngle(e,t,n){if(!e||!t||!n||e.score<.3||t.score<.3||n.score<.3)return 0;var o=Math.atan2(n.y-t.y,n.x-t.x)-Math.atan2(e.y-t.y,e.x-t.x),i=Math.abs(180*o/Math.PI);return i>180?360-i:i}function checkGameLogic(e){if("playing"!==gameState)return;var t=function(t){for(var o=0;o<e.length;o++)if(e[o].name===t)return e[o];return null},o=["left_shoulder","right_shoulder","left_wrist","right_wrist","left_elbow","right_elbow","nose"];for(var i=0;i<o.length;i++){var n=t(o[i]);if(!n||n.score<.3)return}var a=!1,r=t("left_shoulder"),s=t("right_shoulder"),d=t("left_wrist"),l=t("right_wrist"),c=t("left_elbow"),u=t("right_elbow");if(0===gameStage){var g=calculateAngle(r,c,d)>120&&calculateAngle(s,u,l)>120,h=Math.abs(d.y-s.y)<100&&Math.abs(l.y-s.y)<100;g&&h&&(a=!0)}else if(1===gameStage){var f=d.y<r.y,p=l.y<s.y;(f||p)&&(a=!0)}else if(2===gameStage){var m=l.y<s.y,w=d.y>c.y,y=d.y<r.y,v=l.y>u.y;(m&&w||y&&v)&&(a=!0)}else if(3===gameStage){var b=d.y<r.y&&l.y<s.y,k=Math.abs(r.x-s.x),x=Math.abs(d.x-l.x)<k,A=Math.abs(c.x-u.x)>k;b&&x&&A&&(a=!0)}else if(4===gameStage){var _=calculateAngle(r,c,d)>135&&calculateAngle(s,u,l)>135,I=Math.abs(d.y-l.y)<100;_&&I&&(a=!0)}a?(poseHoldCounter++,progressBar.style.width=poseHoldCounter/POSE_HOLD_FRAMES*100+"%",poseHoldCounter>=POSE_HOLD_FRAMES&&(gameStage>=STAGE_NAMES.length-1?(instructionBoard.classList.add("success"),instructionText.textContent="Pose Recognized!",finishGame()):triggerTransition())):(poseHoldCounter=0,progressBar.style.width="0%")}
        function initialize(){instructionText.textContent="MATCH THE POSE",setupCamera().then(function(){return loadPoseDetector()}).then(function(){startButton.disabled=!1,startButton.textContent="Start Game",startButton.onclick=startGame,restartButton.onclick=resetGame,"waiting"===gameState&&gameLoop()}).catch(function(e){videoElement.style.display="none",instructionBoard.classList.add("hidden"),startTitle.textContent="Loading Failed",startButton.style.display="none";if(!document.getElementById("error-message")){var t=document.createElement("p");t.id="error-message",t.className="error-message",t.textContent=e.message,startScreen.appendChild(t)}if(!document.getElementById("error-recommendation")){var o=document.createElement("p");o.id="error-recommendation",o.className="error-recommendation",o.textContent="Please try a modern browser like Chrome or Safari.",startScreen.appendChild(o)}})}initialize();
    </script>
</body>
</html>
